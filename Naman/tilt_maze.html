<!DOCTYPE html>
<html lang="en">
<head>
    <title>Tilting Maze | Naman Mittal</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            --background-color: #ede6e3;
            --wall-color: #36382e;
            --joystick-color: #210124;
            --joystick-head-color: #f06449;
            --ball-color: #f06449;
            --end-color: #7d82b8;
            --text-color: #210124;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        #center {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #game {
            display: grid;
            grid-template-columns: auto 150px;
            grid-template-rows: 1fr auto 1fr;
            gap: 30px;
            perspective: 600px;
        }

        #maze {
            position: relative;
            grid-row: 1 / -1;
            grid-column: 1;
            width: 350px;
            height: 315px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s ease-out;
        }

        #end {
            width: 65px;
            height: 65px;
            border: 5px dashed var(--end-color);
            border-radius: 50%;
        }

        #joystick {
            position: relative;
            background-color: var(--joystick-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 50px;
            grid-row: 2;
        }

        #joystick-head {
            position: relative;
            background-color: var(--joystick-head-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: grab;
            animation: glow 0.6s infinite alternate ease-in-out;
        }

        @keyframes glow {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }

        .joystick-arrow:nth-of-type(1) { position: absolute; bottom: 55px; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid var(--joystick-color); }
        .joystick-arrow:nth-of-type(2) { position: absolute; top: 55px; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid var(--joystick-color); }
        .joystick-arrow:nth-of-type(3) { position: absolute; left: 55px; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-left: 10px solid var(--joystick-color); }
        .joystick-arrow:nth-of-type(4) { position: absolute; right: 55px; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 10px solid var(--joystick-color); }

        #note {
            grid-row: 3;
            grid-column: 2;
            text-align: center;
            font-size: 0.8em;
            color: var(--text-color);
            transition: opacity 2s;
        }

        .author-credit {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: block;
            color: var(--joystick-color);
        }

        .ball {
            position: absolute;
            margin-top: -5px;
            margin-left: -5px;
            border-radius: 50%;
            background-color: var(--ball-color);
            width: 10px;
            height: 10px;
            z-index: 5;
        }

        .wall {
            position: absolute;
            background-color: var(--wall-color);
            transform-origin: top center;
            margin-left: -5px;
        }

        .wall::before, .wall::after {
            display: block; content: ""; width: 10px; height: 10px;
            background-color: inherit; border-radius: 50%; position: absolute;
        }
        .wall::before { top: -5px; }
        .wall::after { bottom: -5px; }

        .black-hole {
            position: absolute;
            margin-top: -9px;
            margin-left: -9px;
            border-radius: 50%;
            background-color: black;
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div id="center">
        <div id="game">
            <div id="maze">
                <div id="end"></div>
            </div>
            <div id="joystick">
                <div class="joystick-arrow"></div>
                <div class="joystick-arrow"></div>
                <div class="joystick-arrow"></div>
                <div class="joystick-arrow"></div>
                <div id="joystick-head"></div>
            </div>
            <div id="note">
                <span class="author-credit">Created by Naman Mittal</span>
                <div id="instruction-text">
                    Click the joystick to start!
                    <p>Move every ball to the center. Ready for hard mode? Press H</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        Math.minmax = (value, limit) => Math.max(Math.min(value, limit), -limit);
        const distance2D = (p1, p2) => Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2);
        const getAngle = (p1, p2) => {
            let angle = Math.atan((p2.y - p1.y) / (p2.x - p1.x));
            if (p2.x - p1.x < 0) angle += Math.PI;
            return angle;
        };

        const closestItCanBe = (cap, ball) => {
            let angle = getAngle(cap, ball);
            const deltaX = Math.cos(angle) * (wallW / 2 + ballSize / 2);
            const deltaY = Math.sin(angle) * (wallW / 2 + ballSize / 2);
            return { x: cap.x + deltaX, y: cap.y + deltaY };
        };

        const rollAroundCap = (cap, ball) => {
            let impactAngle = getAngle(ball, cap);
            let heading = getAngle({ x: 0, y: 0 }, { x: ball.velocityX, y: ball.velocityY });
            let impactHeadingAngle = impactAngle - heading;
            const velocityMagnitude = distance2D({ x: 0, y: 0 }, { x: ball.velocityX, y: ball.velocityY });
            const velocityMagnitudeDiagonalToTheImpact = Math.sin(impactHeadingAngle) * velocityMagnitude;
            const closestDistance = wallW / 2 + ballSize / 2;
            const rotationAngle = Math.atan(velocityMagnitudeDiagonalToTheImpact / closestDistance);
            const deltaFromCap = {
                x: Math.cos(impactAngle + Math.PI - rotationAngle) * closestDistance,
                y: Math.sin(impactAngle + Math.PI - rotationAngle) * closestDistance,
            };
            return { x: ball.x, y: ball.y, velocityX: ball.x - (cap.x + deltaFromCap.x), velocityY: ball.y - (cap.y + deltaFromCap.y) };
        };

        const slow = (number, difference) => {
            if (Math.abs(number) <= difference) return 0;
            return number > difference ? number - difference : number + difference;
        };

        const mazeElement = document.getElementById("maze");
        const joystickHeadElement = document.getElementById("joystick-head");
        const noteElement = document.getElementById("note");
        const instructionText = document.getElementById("instruction-text");

        let hardMode = false;
        let previousTimestamp, gameInProgress, mouseStartX, mouseStartY;
        let accelerationX, accelerationY, frictionX, frictionY;

        const pathW = 25, wallW = 10, ballSize = 10, holeSize = 18;
        let balls = [], ballElements = [], holeElements = [];

        const walls = [
            { column: 0, row: 0, horizontal: true, length: 10 },
            { column: 0, row: 0, horizontal: false, length: 9 },
            { column: 0, row: 9, horizontal: true, length: 10 },
            { column: 10, row: 0, horizontal: false, length: 9 },
            { column: 0, row: 6, horizontal: true, length: 1 },
            { column: 0, row: 8, horizontal: true, length: 1 },
            { column: 1, row: 1, horizontal: true, length: 2 },
            { column: 1, row: 7, horizontal: true, length: 1 },
            { column: 2, row: 2, horizontal: true, length: 2 },
            { column: 2, row: 4, horizontal: true, length: 1 },
            { column: 2, row: 5, horizontal: true, length: 1 },
            { column: 2, row: 6, horizontal: true, length: 1 },
            { column: 3, row: 3, horizontal: true, length: 1 },
            { column: 3, row: 8, horizontal: true, length: 3 },
            { column: 4, row: 6, horizontal: true, length: 1 },
            { column: 5, row: 2, horizontal: true, length: 2 },
            { column: 5, row: 7, horizontal: true, length: 1 },
            { column: 6, row: 1, horizontal: true, length: 1 },
            { column: 6, row: 6, horizontal: true, length: 2 },
            { column: 7, row: 3, horizontal: true, length: 2 },
            { column: 7, row: 7, horizontal: true, length: 2 },
            { column: 8, row: 1, horizontal: true, length: 1 },
            { column: 8, row: 2, horizontal: true, length: 1 },
            { column: 8, row: 3, horizontal: true, length: 1 },
            { column: 8, row: 4, horizontal: true, length: 2 },
            { column: 8, row: 8, horizontal: true, length: 2 },
            { column: 1, row: 1, horizontal: false, length: 2 },
            { column: 1, row: 4, horizontal: false, length: 2 },
            { column: 2, row: 2, horizontal: false, length: 2 },
            { column: 2, row: 5, horizontal: false, length: 1 },
            { column: 2, row: 7, horizontal: false, length: 2 },
            { column: 3, row: 0, horizontal: false, length: 1 },
            { column: 3, row: 4, horizontal: false, length: 1 },
            { column: 3, row: 6, horizontal: false, length: 2 },
            { column: 4, row: 1, horizontal: false, length: 2 },
            { column: 4, row: 6, horizontal: false, length: 1 },
            { column: 5, row: 0, horizontal: false, length: 2 },
            { column: 5, row: 6, horizontal: false, length: 1 },
            { column: 5, row: 8, horizontal: false, length: 1 },
            { column: 6, row: 4, horizontal: false, length: 1 },
            { column: 6, row: 6, horizontal: false, length: 1 },
            { column: 7, row: 1, horizontal: false, length: 4 },
            { column: 7, row: 7, horizontal: false, length: 2 },
            { column: 8, row: 2, horizontal: false, length: 1 },
            { column: 8, row: 4, horizontal: false, length: 2 },
            { column: 9, row: 1, horizontal: false, length: 1 },
            { column: 9, row: 5, horizontal: false, length: 2 },
        ].map(w => ({
            x: w.column * (pathW + wallW),
            y: w.row * (pathW + wallW),
            horizontal: w.horizontal,
            length: w.length * (pathW + wallW)
        }));

        const holes = [
            { column: 0, row: 5 }, { column: 2, row: 0 }, { column: 2, row: 4 },
            { column: 4, row: 6 }, { column: 6, row: 2 }, { column: 6, row: 8 },
            { column: 8, row: 1 }, { column: 8, row: 2 }
        ].map(h => ({
            x: h.column * (wallW + pathW) + (wallW / 2 + pathW / 2),
            y: h.row * (wallW + pathW) + (wallW / 2 + pathW / 2)
        }));

        function resetGame() {
            gameInProgress = false;
            mazeElement.style.transform = `rotateY(0deg) rotateX(0deg)`;
            joystickHeadElement.style.cssText = `left: 0; top: 0; animation: glow 0.6s infinite alternate; cursor: grab;`;
            
            instructionText.innerHTML = hardMode 
                ? `Click joystick to start!<p>Hard mode: Avoid black holes. Press E for Easy.</p>`
                : `Click joystick to start!<p>Move every ball to the center. Press H for Hard.</p>`;
            noteElement.style.opacity = 1;

            balls = [
                { column: 0, row: 0 }, { column: 9, row: 0 },
                { column: 0, row: 8 }, { column: 9, row: 8 }
            ].map(b => ({
                x: b.column * (wallW + pathW) + (wallW/2 + pathW/2),
                y: b.row * (wallW + pathW) + (wallW/2 + pathW/2),
                velocityX: 0, velocityY: 0
            }));

            if (!ballElements.length) {
                balls.forEach(b => {
                    const el = document.createElement("div");
                    el.className = "ball";
                    mazeElement.appendChild(el);
                    ballElements.push(el);
                });
            }

            holeElements.forEach(h => mazeElement.removeChild(h));
            holeElements = [];
            if (hardMode) {
                holes.forEach(h => {
                    const el = document.createElement("div");
                    el.className = "black-hole";
                    el.style.left = h.x + "px"; el.style.top = h.y + "px";
                    mazeElement.appendChild(el);
                    holeElements.push(el);
                });
            }
            updateBallUI();
        }

        function updateBallUI() {
            balls.forEach((b, i) => {
                ballElements[i].style.left = b.x + "px";
                ballElements[i].style.top = b.y + "px";
            });
        }

        walls.forEach(w => {
            const el = document.createElement("div");
            el.className = "wall";
            el.style.cssText = `left: ${w.x}px; top: ${w.y}px; width: ${wallW}px; height: ${w.length}px; transform: rotate(${w.horizontal ? -90 : 0}deg);`;
            mazeElement.appendChild(el);
        });

        joystickHeadElement.addEventListener("mousedown", (e) => {
            if (!gameInProgress) {
                mouseStartX = e.clientX; mouseStartY = e.clientY;
                gameInProgress = true;
                noteElement.style.opacity = 0;
                joystickHeadElement.style.animation = "none";
                joystickHeadElement.style.cursor = "grabbing";
                window.requestAnimationFrame(main);
            }
        });

        window.addEventListener("mousemove", (e) => {
            if (gameInProgress) {
                const dx = -Math.minmax(mouseStartX - e.clientX, 15);
                const dy = -Math.minmax(mouseStartY - e.clientY, 15);
                joystickHeadElement.style.left = dx + "px";
                joystickHeadElement.style.top = dy + "px";
                const ry = dx * 0.8; const rx = dy * 0.8;
                mazeElement.style.transform = `rotateY(${ry}deg) rotateX(${-rx}deg)`;
                const g = 2; const f = 0.01;
                accelerationX = g * Math.sin((ry / 180) * Math.PI);
                accelerationY = g * Math.sin((rx / 180) * Math.PI);
                frictionX = g * Math.cos((ry / 180) * Math.PI) * f;
                frictionY = g * Math.cos((rx / 180) * Math.PI) * f;
            }
        });

        window.addEventListener("keydown", (e) => {
            if (e.key === " ") resetGame();
            if (e.key.toLowerCase() === "h") { hardMode = true; resetGame(); }
            if (e.key.toLowerCase() === "e") { hardMode = false; resetGame(); }
        });

        function main(ts) {
            if (!gameInProgress) return;
            if (previousTimestamp === undefined) { previousTimestamp = ts; window.requestAnimationFrame(main); return; }
            const dt = (ts - previousTimestamp) / 16;
            
            balls.forEach(ball => {
                ball.velocityX = accelerationX === 0 ? slow(ball.velocityX, frictionX * dt) : Math.minmax(ball.velocityX + (accelerationX - Math.sign(accelerationX) * frictionX) * dt, 1.5);
                ball.velocityY = accelerationY === 0 ? slow(ball.velocityY, frictionY * dt) : Math.minmax(ball.velocityY + (accelerationY - Math.sign(accelerationY) * frictionY) * dt, 1.5);
                
                ball.nextX = ball.x + ball.velocityX;
                ball.nextY = ball.y + ball.velocityY;

                walls.forEach(w => {
                    if (w.horizontal) {
                        if (ball.nextY + 5 >= w.y - 5 && ball.nextY - 5 <= w.y + 5) {
                            if (ball.nextX >= w.x && ball.nextX <= w.x + w.length) {
                                ball.velocityY = -ball.velocityY / 3;
                                ball.nextY = ball.y;
                            }
                        }
                    } else {
                        if (ball.nextX + 5 >= w.x - 5 && ball.nextX - 5 <= w.x + 5) {
                            if (ball.nextY >= w.y && ball.nextY <= w.y + w.length) {
                                ball.velocityX = -ball.velocityX / 3;
                                ball.nextX = ball.x;
                            }
                        }
                    }
                });

                if (hardMode) {
                    holes.forEach((h, i) => {
                        if (distance2D(h, { x: ball.nextX, y: ball.nextY }) <= holeSize / 2) {
                            gameInProgress = false;
                            instructionText.innerHTML = `Ball fell in! Press space to reset.<p>Created by Naman Mittal</p>`;
                            noteElement.style.opacity = 1;
                        }
                    });
                }

                ball.x = ball.nextX; ball.y = ball.nextY;
            });

            updateBallUI();

            if (balls.every(b => distance2D(b, { x: 175, y: 157.5 }) < 32.5)) {
                gameInProgress = false;
                instructionText.innerHTML = `Victory! All balls centered.<p>Created by Naman Mittal</p>`;
                noteElement.style.opacity = 1;
            } else {
                previousTimestamp = ts;
                window.requestAnimationFrame(main);
            }
        }

        resetGame();
    </script>
</body>
</html>