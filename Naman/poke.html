<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©Hub - Ultimate Pok√©mon Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        
        :root {
            --normal: #A8A878; --fire: #F08030; --water: #6890F0; --electric: #F8D030;
            --grass: #78C850; --ice: #98D8D8; --fighting: #C03028; --poison: #A040A0;
            --ground: #E0C068; --flying: #A890F0; --psychic: #F85888; --bug: #A8B820;
            --rock: #B8A038; --ghost: #705898; --dragon: #7038F8; --dark: #705848;
            --steel: #B8B8D0; --fairy: #EE99AC;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .type-normal { background: linear-gradient(145deg, #c4c4a4, #8c8c5c); }
        .type-fire { background: linear-gradient(145deg, #ff9d55, #cc5500); }
        .type-water { background: linear-gradient(145deg, #8bb8ff, #4a6fc4); }
        .type-electric { background: linear-gradient(145deg, #ffe066, #c4a000); }
        .type-grass { background: linear-gradient(145deg, #9bde6a, #4a9030); }
        .type-ice { background: linear-gradient(145deg, #b8f0f0, #68b8c0); }
        .type-fighting { background: linear-gradient(145deg, #e04038, #901810); }
        .type-poison { background: linear-gradient(145deg, #c860c8, #702870); }
        .type-ground { background: linear-gradient(145deg, #f0d898, #a88830); }
        .type-flying { background: linear-gradient(145deg, #c4b8f8, #7860c8); }
        .type-psychic { background: linear-gradient(145deg, #ff80a8, #c83060); }
        .type-bug { background: linear-gradient(145deg, #c8d840, #788000); }
        .type-rock { background: linear-gradient(145deg, #d8c058, #887018); }
        .type-ghost { background: linear-gradient(145deg, #9878b8, #503870); }
        .type-dragon { background: linear-gradient(145deg, #9058f8, #4810c8); }
        .type-dark { background: linear-gradient(145deg, #907868, #483828); }
        .type-steel { background: linear-gradient(145deg, #d8d8e8, #9898b0); }
        .type-fairy { background: linear-gradient(145deg, #ffbbcc, #cc6688); }
        
        .pokemon-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: linear-gradient(145deg, #ffffff 0%, #e8e8e8 100%);
            transform-style: preserve-3d;
            perspective: 1000px;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.3),
                0 5px 15px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .pokemon-card:hover {
            transform: translateY(-15px) rotateX(5deg) rotateY(-5deg) scale(1.05);
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.4),
                0 15px 30px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }
        
        .card-3d {
            background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.3),
                0 5px 20px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.9),
                inset 0 -1px 0 rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.4);
            transform-style: preserve-3d;
        }
        
        .card-3d:hover {
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.4),
                0 10px 25px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,1);
        }
        
        .stat-bar {
            transition: width 1s ease-out;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            box-shadow: 0 2px 10px rgba(34, 197, 94, 0.5);
            border-radius: 10px;
        }
        .stat-bar.attack { background: linear-gradient(90deg, #f97316, #ea580c); box-shadow: 0 2px 10px rgba(249, 115, 22, 0.5); }
        .stat-bar.defense { background: linear-gradient(90deg, #3b82f6, #2563eb); box-shadow: 0 2px 10px rgba(59, 130, 246, 0.5); }
        .stat-bar.sp-attack { background: linear-gradient(90deg, #a855f7, #9333ea); box-shadow: 0 2px 10px rgba(168, 85, 247, 0.5); }
        .stat-bar.sp-defense { background: linear-gradient(90deg, #14b8a6, #0d9488); box-shadow: 0 2px 10px rgba(20, 184, 166, 0.5); }
        .stat-bar.speed { background: linear-gradient(90deg, #f43f5e, #e11d48); box-shadow: 0 2px 10px rgba(244, 63, 94, 0.5); }
        .stat-bar.hp { background: linear-gradient(90deg, #22c55e, #16a34a); box-shadow: 0 2px 10px rgba(34, 197, 94, 0.5); }
        
        .nav-3d {
            background: linear-gradient(180deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.4),
                0 5px 20px rgba(102, 126, 234, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }
        
        .nav-item {
            position: relative;
            transition: all 0.3s ease;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
        .nav-item:hover::after, .nav-item.active::after {
            width: 100%;
        }
        .nav-item:hover {
            transform: translateY(-2px);
            text-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        .page { display: none; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(59, 130, 246, 0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        
        .bounce { animation: bounce 0.5s ease; }
        .shake { animation: shake 0.3s ease; }
        .pulse { animation: pulse 2s ease infinite; }
        .float { animation: float 3s ease-in-out infinite; }
        
        .health-bar {
            transition: width 0.5s ease;
            box-shadow: 0 0 10px currentColor;
        }
        
        .type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.3),
                inset 0 -1px 0 rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        
        .type-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 6px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.4);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .btn-3d {
            background: linear-gradient(145deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 
                0 6px 20px rgba(37, 99, 235, 0.4),
                0 3px 10px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3),
                inset 0 -2px 0 rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .btn-3d:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 30px rgba(37, 99, 235, 0.5),
                0 5px 15px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.4);
        }
        
        .btn-3d:active {
            transform: translateY(0);
            box-shadow: 
                0 3px 10px rgba(37, 99, 235, 0.3),
                inset 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .input-3d {
            background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 100%);
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.1),
                0 1px 0 rgba(255,255,255,0.8);
            border: 2px solid rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .input-3d:focus {
            box-shadow: 
                inset 0 2px 5px rgba(59, 130, 246, 0.2),
                0 0 0 3px rgba(59, 130, 246, 0.3),
                0 1px 0 rgba(255,255,255,0.8);
            border-color: #3b82f6;
        }
        
        .pokemon-sprite {
            image-rendering: pixelated;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }
        .pokemon-sprite:hover {
            transform: scale(1.15) rotate(5deg);
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.4));
        }
        
        .favorite-btn {
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .favorite-btn.active {
            color: #ef4444;
            transform: scale(1.3);
            filter: drop-shadow(0 4px 8px rgba(239, 68, 68, 0.5));
        }
        
        .team-slot {
            min-height: 120px;
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .team-slot.filled {
            border: 2px solid #22c55e;
            background: linear-gradient(145deg, #f0fdf4, #dcfce7);
            box-shadow: 
                0 5px 20px rgba(34, 197, 94, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .team-slot:hover {
            border-color: #3b82f6;
            background: linear-gradient(145deg, #eff6ff, #dbeafe);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        
        .battle-pokemon {
            transition: all 0.3s ease;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.4));
        }
        .battle-pokemon.attacking {
            animation: shake 0.3s ease;
        }
        .battle-pokemon.damaged {
            filter: brightness(1.5) saturate(0.5) drop-shadow(0 10px 30px rgba(255,0,0,0.5));
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #e2e8f0, #cbd5e1);
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #94a3b8, #64748b);
            border-radius: 4px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            animation: modalIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.8) rotateX(10deg); }
            to { opacity: 1; transform: scale(1) rotateX(0); }
        }
        
        .title-3d {
            text-shadow: 
                0 1px 0 #ccc,
                0 2px 0 #c9c9c9,
                0 3px 0 #bbb,
                0 4px 0 #b9b9b9,
                0 5px 0 #aaa,
                0 6px 1px rgba(0,0,0,.1),
                0 0 5px rgba(0,0,0,.1),
                0 1px 3px rgba(0,0,0,.3),
                0 3px 5px rgba(0,0,0,.2),
                0 5px 10px rgba(0,0,0,.25),
                0 10px 10px rgba(0,0,0,.2),
                0 20px 20px rgba(0,0,0,.15);
        }
        
        .type-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        .glow-effect {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }
        
        .section-title {
            background: linear-gradient(90deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="nav-3d text-white sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-red-500 rounded-full flex items-center justify-center shadow-lg transform hover:rotate-12 transition-transform">
                      <img src="https://cdn3.emoji.gg/emojis/2194-pokeballspin.gif" width="64px" height="64px" alt="PokeballSpin">
                    </div>
                    <h1 class="text-2xl font-bold title-3d text-white">Pok√©Hub</h1>
                </div>
                <div class="hidden md:flex space-x-6">
                    <button class="nav-item active px-3 py-2 font-medium hover:text-yellow-300" data-page="pokedex">
                        <img src="https://cdn3.emoji.gg/emojis/599971-pika45.png" width="64px" height="64px" alt="pika45"> Pok√©dex
                    </button>
                    <button class="nav-item px-3 py-2 font-medium hover:text-yellow-300" data-page="battle">
                      <img src="https://cdn3.emoji.gg/emojis/3369-charizard.gif" class="w-25 h-20 float" alt="charizard"> Battle
                    <button class="nav-item px-3 py-2 font-medium hover:text-yellow-300" data-page="team">
                        <img src="https://cdn3.emoji.gg/emojis/80085-umbreon.gif" width="64px" height="64px" alt="Umbreon"> Team
                    </button>
                    <button class="nav-item px-3 py-2 font-medium hover:text-yellow-300" data-page="evolution">üîÑ Evolution</button>
                    <button class="nav-item px-3 py-2 font-medium hover:text-yellow-300" data-page="types">üéØ Types</button>
                    <button class="nav-item px-3 py-2 font-medium hover:text-yellow-300" data-page="random">üé≤ Random</button>
                    <button class="nav-item px-3 py-2 font-medium hover:text-yellow-300" data-page="compare">üìä Compare</button>
                </div>
                <button id="mobileMenuBtn" class="md:hidden text-2xl hover:scale-110 transition-transform">‚ò∞</button>
            </div>
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="hidden md:hidden pb-4 space-y-2">
                <button class="nav-item block w-full text-left px-3 py-2 hover:bg-white/20 rounded" data-page="pokedex">üìñ Pok√©dex</button>
                <button class="nav-item block w-full text-left px-3 py-2 hover:bg-white/20 rounded" data-page="battle">‚öîÔ∏è Battle</button>
                <button class="nav-item block w-full text-left px-3 py-2 hover:bg-white/20 rounded" data-page="team">üë• Team Builder</button>
                <button class="nav-item block w-full text-left px-3 py-2 hover:bg-white/20 rounded" data-page="evolution">üîÑ Evolution</button>
                <button class="nav-item block w-full text-left px-3 py-2 hover:bg-white/20 rounded" data-page="types">üéØ Types</button>
                <button class="nav-item block w-full text-left px-3 py-2 hover:bg-white/20 rounded" data-page="random">üé≤ Randomizer</button>
                <button class="nav-item block w-full text-left px-3 py-2 hover:bg-white/20 rounded" data-page="compare">üìä Compare</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Pok√©dex Page -->
        <div id="pokedex" class="page active">
            <div class="mb-8">
                <h2 class="text-4xl font-bold text-white mb-6 section-title flex items-center gap-3">
                    <img src="https://cdn3.emoji.gg/emojis/17524-pika.png" class="w-20 h-20 float"> Ultimate Pok√©dex
                </h2>
                <div class="card-3d rounded-2xl p-6 mb-6">
                    <div class="flex flex-wrap gap-4 mb-4">
                        <input type="text" id="searchInput" placeholder="Search by name or ID..." 
                            class="input-3d flex-1 min-w-64 px-4 py-3 rounded-xl focus:outline-none transition">
                        <select id="typeFilter" class="input-3d px-4 py-3 rounded-xl focus:outline-none cursor-pointer">
                            <option value="">All Types</option>
                        </select>
                        <select id="genFilter" class="input-3d px-4 py-3 rounded-xl focus:outline-none cursor-pointer">
                            <option value="">All Generations</option>
                            <option value="1">Gen I (1-151)</option>
                            <option value="2">Gen II (152-251)</option>
                            <option value="3">Gen III (252-386)</option>
                            <option value="4">Gen IV (387-493)</option>
                            <option value="5">Gen V (494-649)</option>
                            <option value="6">Gen VI (650-721)</option>
                            <option value="7">Gen VII (722-809)</option>
                            <option value="8">Gen VIII (810-905)</option>
                        </select>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center space-x-2 px-4 py-3 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-xl border-2 border-yellow-200 cursor-pointer hover:shadow-md transition">
                            <input type="checkbox" id="shinyToggle" class="w-5 h-5 accent-yellow-500">
                            <span>‚ú® Shiny</span>
                        </label>
                        <label class="flex items-center space-x-2 px-4 py-3 bg-gradient-to-r from-red-50 to-red-100 rounded-xl border-2 border-red-200 cursor-pointer hover:shadow-md transition">
                            <input type="checkbox" id="favoritesOnly" class="w-5 h-5 accent-red-500">
                            <span>‚ù§Ô∏è Favorites</span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="pokemonGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
            <div id="loadingIndicator" class="flex justify-center py-8">
                <div class="loading-spinner"></div>
            </div>
            <div id="loadMoreBtn" class="text-center py-8 hidden">
                <button class="btn-3d px-8 py-3 text-white rounded-xl font-semibold">
                    Load More Pok√©mon
                </button>
            </div>
        </div>

        <!-- Battle Page -->
        <div id="battle" class="page">
            <h2 class="text-4xl font-bold text-white mb-6 flex items-center gap-3">
              <img src="https://cdn3.emoji.gg/emojis/6134-charizard.gif" width="64px" height="64px" alt="Charizard">Battle Simulator
            </h2>
            <div id="battleSetup" class="grid md:grid-cols-2 gap-8">
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <img src="https://cdn3.emoji.gg/emojis/Pokemon_Pikachu.png" class="w-6 h-6"> Your Pok√©mon
                    </h3>
                    <input type="text" id="playerPokemonSearch" placeholder="Search Pok√©mon..." 
                        class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none mb-4">
                    <div id="playerPokemonList" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto scrollbar-thin"></div>
                    <div id="selectedPlayerPokemon" class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl hidden"></div>
                </div>
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">ü§ñ AI Opponent</h3>
                    <button id="randomOpponent" class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-semibold hover:from-purple-700 hover:to-purple-800 transition mb-4 shadow-lg">
                        üé≤ Random Opponent
                    </button>
                    <div id="selectedOpponentPokemon" class="p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl"></div>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="startBattle" class="btn-3d px-12 py-4 bg-gradient-to-r from-red-600 to-red-700 text-white text-xl rounded-2xl font-bold hover:from-red-700 hover:to-red-800 transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ‚öîÔ∏è Start Battle!
                </button>
            </div>
            
            <!-- Battle Arena -->
            <div id="battleArena" class="hidden mt-8">
                <div class="bg-gradient-to-b from-sky-300 via-sky-200 to-green-300 rounded-3xl p-8 shadow-2xl border-4 border-white/50">
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Opponent -->
                        <div class="text-center">
                            <div class="card-3d rounded-2xl p-4 mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span id="opponentName" class="font-bold text-lg"></span>
                                    <span id="opponentLevel" class="text-gray-600">Lv. 50</span>
                                </div>
                                <div class="bg-gray-300 rounded-full h-5 overflow-hidden shadow-inner">
                                    <div id="opponentHP" class="health-bar bg-gradient-to-r from-green-400 to-green-500 h-full" style="width: 100%"></div>
                                </div>
                                <div id="opponentHPText" class="text-sm text-gray-600 mt-1"></div>
                            </div>
                            <img id="opponentSprite" class="battle-pokemon w-48 h-48 mx-auto pokemon-sprite">
                        </div>
                        <!-- Player -->
                        <div class="text-center order-first md:order-last">
                            <img id="playerSprite" class="battle-pokemon w-48 h-48 mx-auto pokemon-sprite mb-4">
                            <div class="card-3d rounded-2xl p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span id="playerName" class="font-bold text-lg"></span>
                                    <span id="playerLevel" class="text-gray-600">Lv. 50</span>
                                </div>
                                <div class="bg-gray-300 rounded-full h-5 overflow-hidden shadow-inner">
                                    <div id="playerHP" class="health-bar bg-gradient-to-r from-green-400 to-green-500 h-full" style="width: 100%"></div>
                                </div>
                                <div id="playerHPText" class="text-sm text-gray-600 mt-1"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Battle Log -->
                    <div id="battleLog" class="mt-6 card-3d rounded-xl p-4 h-32 overflow-y-auto scrollbar-thin text-sm"></div>
                    
                    <!-- Move Buttons -->
                    <div id="moveButtons" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6"></div>
                    
                    <div id="battleResult" class="hidden text-center mt-6">
                        <h3 id="resultText" class="text-3xl font-bold mb-4"></h3>
                        <button id="newBattle" class="btn-3d px-8 py-3 text-white rounded-xl font-semibold">
                            New Battle
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Builder Page -->
        <div id="team" class="page">
            <h2 class="text-4xl font-bold text-white mb-6 flex items-center gap-3">
                <img src="https://cdn3.emoji.gg/emojis/1037-rimuru-disgust.png" class="w-30 h-30 float"> Team Builder & Analyzer
            </h2>
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="card-3d rounded-2xl p-6 mb-6">
                        <h3 class="text-xl font-bold mb-4">Your Team</h3>
                        <div id="teamSlots" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="team-slot rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer" data-slot="0">
                                <span class="text-4xl text-gray-300">+</span>
                                <span class="text-gray-400">Slot 1</span>
                            </div>
                            <div class="team-slot rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer" data-slot="1">
                                <span class="text-4xl text-gray-300">+</span>
                                <span class="text-gray-400">Slot 2</span>
                            </div>
                            <div class="team-slot rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer" data-slot="2">
                                <span class="text-4xl text-gray-300">+</span>
                                <span class="text-gray-400">Slot 3</span>
                            </div>
                            <div class="team-slot rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer" data-slot="3">
                                <span class="text-4xl text-gray-300">+</span>
                                <span class="text-gray-400">Slot 4</span>
                            </div>
                            <div class="team-slot rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer" data-slot="4">
                                <span class="text-4xl text-gray-300">+</span>
                                <span class="text-gray-400">Slot 5</span>
                            </div>
                            <div class="team-slot rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer" data-slot="5">
                                <span class="text-4xl text-gray-300">+</span>
                                <span class="text-gray-400">Slot 6</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 mt-6">
                            <button id="saveTeam" class="flex-1 min-w-[120px] px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 shadow-lg transition">
                                üíæ Save
                            </button>
                            <button id="loadTeam" class="flex-1 min-w-[120px] px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 shadow-lg transition">
                                üìÇ Load
                            </button>
                            <button id="exportTeam" class="flex-1 min-w-[120px] px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-semibold hover:from-purple-600 hover:to-purple-700 shadow-lg transition">
                                üì§ Export
                            </button>
                            <button id="clearTeam" class="flex-1 min-w-[120px] px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-semibold hover:from-red-600 hover:to-red-700 shadow-lg transition">
                                üóëÔ∏è Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Team Analysis -->
                    <div class="card-3d rounded-2xl p-6">
                        <h3 class="text-xl font-bold mb-4">üìä Team Analysis</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold mb-3 text-green-600">‚úÖ Resistances</h4>
                                <div id="teamResistances" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-3 text-red-600">‚ö†Ô∏è Weaknesses</h4>
                                <div id="teamWeaknesses" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                        <div id="teamWarnings" class="mt-4"></div>
                        <div class="mt-6">
                            <h4 class="font-semibold mb-3">üìà Stat Distribution</h4>
                            <canvas id="teamStatsChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Pok√©mon Selector -->
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">Select Pok√©mon</h3>
                    <input type="text" id="teamSearchInput" placeholder="Search..." 
                        class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none mb-4">
                    <div id="teamPokemonList" class="max-h-96 overflow-y-auto scrollbar-thin space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Evolution Page -->
        <div id="evolution" class="page">
            <h2 class="text-4xl font-bold text-white mb-6">üîÑ Evolution Explorer</h2>
            <div class="card-3d rounded-2xl p-6 mb-6">
                <input type="text" id="evolutionSearch" placeholder="Search Pok√©mon to see evolution chain..." 
                    class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none mb-4">
                <div id="evolutionSuggestions" class="grid grid-cols-4 md:grid-cols-8 gap-2"></div>
            </div>
            <div id="evolutionChain" class="card-3d rounded-2xl p-8 min-h-64">
                <div class="text-center text-gray-400">
                    <span class="text-6xl">üîç</span>
                    <p class="mt-4">Search for a Pok√©mon to view its evolution chain</p>
                </div>
            </div>
        </div>

        <!-- Type Matchup Page -->
        <div id="types" class="page">
            <h2 class="text-4xl font-bold text-white mb-6">üéØ Type Matchup Visualizer</h2>
            <div class="card-3d rounded-2xl p-6 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-medium text-gray-600 mb-2">Primary Type</label>
                        <select id="type1Select" class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none cursor-pointer">
                            <option value="">Select Type</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-medium text-gray-600 mb-2">Secondary Type (Optional)</label>
                        <select id="type2Select" class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none cursor-pointer">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="typeResults" class="grid md:grid-cols-3 gap-6">
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-red-600 mb-4">üî• Weak To (2x/4x)</h3>
                    <div id="weakTo" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-green-600 mb-4">üõ°Ô∏è Resistant To (0.5x/0.25x)</h3>
                    <div id="resistantTo" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-600 mb-4">‚ùå Immune To (0x)</h3>
                    <div id="immuneTo" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <div class="mt-8 card-3d rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4">üìä Full Type Chart</h3>
                <div class="overflow-x-auto">
                    <table id="typeChart" class="w-full text-xs"></table>
                </div>
            </div>
        </div>

        <!-- Randomizer Page -->
        <div id="random" class="page">
            <h2 class="text-4xl font-bold text-white mb-6">üé≤ Pok√©mon Randomizer</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Generation</label>
                            <select id="randomGen" class="input-3d w-full px-4 py-3 rounded-xl cursor-pointer">
                                <option value="">Any Generation</option>
                                <option value="1">Gen I</option>
                                <option value="2">Gen II</option>
                                <option value="3">Gen III</option>
                                <option value="4">Gen IV</option>
                                <option value="5">Gen V</option>
                                <option value="6">Gen VI</option>
                                <option value="7">Gen VII</option>
                                <option value="8">Gen VIII</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Type</label>
                            <select id="randomType" class="input-3d w-full px-4 py-3 rounded-xl cursor-pointer">
                                <option value="">Any Type</option>
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="legendaryOnly" class="w-5 h-5 accent-purple-500">
                                <span>Legendary Only</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="excludeLegendary" class="w-5 h-5 accent-gray-500">
                                <span>Exclude Legendary</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button id="randomSingle" class="btn-3d px-4 py-3 text-white rounded-xl font-semibold">
                                üéØ Random Pok√©mon
                            </button>
                            <button id="randomTeam" class="px-4 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-semibold hover:from-purple-700 hover:to-purple-800 shadow-lg transition">
                                üë• Random Team (6)
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <h4 class="font-bold mb-4">üèÜ Challenge Mode</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="challenge-btn px-3 py-2 bg-gradient-to-r from-orange-100 to-orange-200 text-orange-700 rounded-lg hover:from-orange-200 hover:to-orange-300 text-sm font-medium shadow transition" data-challenge="mono">
                                Mono-Type Team
                            </button>
                            <button class="challenge-btn px-3 py-2 bg-gradient-to-r from-pink-100 to-pink-200 text-pink-700 rounded-lg hover:from-pink-200 hover:to-pink-300 text-sm font-medium shadow transition" data-challenge="baby">
                                Baby Pok√©mon Only
                            </button>
                            <button class="challenge-btn px-3 py-2 bg-gradient-to-r from-indigo-100 to-indigo-200 text-indigo-700 rounded-lg hover:from-indigo-200 hover:to-indigo-300 text-sm font-medium shadow transition" data-challenge="starter">
                                Starters Only
                            </button>
                            <button class="challenge-btn px-3 py-2 bg-gradient-to-r from-green-100 to-green-200 text-green-700 rounded-lg hover:from-green-200 hover:to-green-300 text-sm font-medium shadow transition" data-challenge="nfe">
                                NFE Only
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">üéâ Result</h3>
                    <div id="randomResult" class="min-h-64 flex items-center justify-center">
                        <div class="text-center text-gray-400">
                            <span class="text-6xl">üé∞</span>
                            <p class="mt-4">Click a button to generate random Pok√©mon!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Page -->
        <div id="compare" class="page">
            <h2 class="text-4xl font-bold text-white mb-6">üìä Stats Comparison</h2>
            <div class="card-3d rounded-2xl p-6 mb-6">
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Pok√©mon 1</label>
                        <input type="text" id="compare1" placeholder="Search..." 
                            class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none">
                        <div id="compare1Suggestions" class="mt-2 space-y-1"></div>
                        <div id="compare1Selected" class="mt-2"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Pok√©mon 2</label>
                        <input type="text" id="compare2" placeholder="Search..." 
                            class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none">
                        <div id="compare2Suggestions" class="mt-2 space-y-1"></div>
                        <div id="compare2Selected" class="mt-2"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Pok√©mon 3 (Optional)</label>
                        <input type="text" id="compare3" placeholder="Search..." 
                            class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none">
                        <div id="compare3Suggestions" class="mt-2 space-y-1"></div>
                        <div id="compare3Selected" class="mt-2"></div>
                    </div>
                </div>
                <button id="compareBtn" class="btn-3d w-full mt-4 px-4 py-3 text-white rounded-xl font-semibold">
                    üîç Compare Stats
                </button>
            </div>
            
            <div id="compareResults" class="grid md:grid-cols-2 gap-6">
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">üìä Bar Chart Comparison</h3>
                    <canvas id="compareBarChart" height="300"></canvas>
                </div>
                <div class="card-3d rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">üï∏Ô∏è Radar Chart</h3>
                    <canvas id="compareRadarChart" height="300"></canvas>
                </div>
            </div>
            
            <div id="statWinners" class="mt-6 card-3d rounded-2xl p-6 hidden">
                <h3 class="text-xl font-bold mb-4">üèÜ Stat Leaders</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4" id="winnersGrid"></div>
            </div>
        </div>
    </main>

    <!-- Pokemon Detail Modal -->
    <div id="pokemonModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="modal card-3d rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Team Pokemon Selector Modal -->
    <div id="teamSelectorModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="modal card-3d rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Select Pok√©mon for Team</h3>
                    <button id="closeTeamSelector" class="text-2xl hover:text-red-500 transition">√ó</button>
                </div>
                <input type="text" id="teamModalSearch" placeholder="Search Pok√©mon..." 
                    class="input-3d w-full px-4 py-3 rounded-xl focus:outline-none mb-4">
                <div id="teamModalList" class="grid grid-cols-4 md:grid-cols-6 gap-3 max-h-96 overflow-y-auto scrollbar-thin"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const state = {
            pokemon: [],
            allPokemon: [],
            loadedPokemonData: {}, // Cache for loaded pokemon with their types
            favorites: JSON.parse(localStorage.getItem('pokeFavorites')) || [],
            team: JSON.parse(localStorage.getItem('pokeTeam')) || [null, null, null, null, null, null],
            types: [],
            typeEffectiveness: {},
            currentPage: 0,
            pageSize: 20,
            isLoading: false,
            showShiny: false,
            battleState: null,
            comparePokemon: [null, null, null],
            charts: {},
            currentTypeFilter: ''
        };

        // Type effectiveness chart
        const typeChart = {
            normal: { rock: 0.5, ghost: 0, steel: 0.5 },
            fire: { fire: 0.5, water: 0.5, grass: 2, ice: 2, bug: 2, rock: 0.5, dragon: 0.5, steel: 2 },
            water: { fire: 2, water: 0.5, grass: 0.5, ground: 2, rock: 2, dragon: 0.5 },
            electric: { water: 2, electric: 0.5, grass: 0.5, ground: 0, flying: 2, dragon: 0.5 },
            grass: { fire: 0.5, water: 2, grass: 0.5, poison: 0.5, ground: 2, flying: 0.5, bug: 0.5, rock: 2, dragon: 0.5, steel: 0.5 },
            ice: { fire: 0.5, water: 0.5, grass: 2, ice: 0.5, ground: 2, flying: 2, dragon: 2, steel: 0.5 },
            fighting: { normal: 2, ice: 2, poison: 0.5, flying: 0.5, psychic: 0.5, bug: 0.5, rock: 2, ghost: 0, dark: 2, steel: 2, fairy: 0.5 },
            poison: { grass: 2, poison: 0.5, ground: 0.5, rock: 0.5, ghost: 0.5, steel: 0, fairy: 2 },
            ground: { fire: 2, electric: 2, grass: 0.5, poison: 2, flying: 0, bug: 0.5, rock: 2, steel: 2 },
            flying: { electric: 0.5, grass: 2, fighting: 2, bug: 2, rock: 0.5, steel: 0.5 },
            psychic: { fighting: 2, poison: 2, psychic: 0.5, dark: 0, steel: 0.5 },
            bug: { fire: 0.5, grass: 2, fighting: 0.5, poison: 0.5, flying: 0.5, psychic: 2, ghost: 0.5, dark: 2, steel: 0.5, fairy: 0.5 },
            rock: { fire: 2, ice: 2, fighting: 0.5, ground: 0.5, flying: 2, bug: 2, steel: 0.5 },
            ghost: { normal: 0, psychic: 2, ghost: 2, dark: 0.5 },
            dragon: { dragon: 2, steel: 0.5, fairy: 0 },
            dark: { fighting: 0.5, psychic: 2, ghost: 2, dark: 0.5, fairy: 0.5 },
            steel: { fire: 0.5, water: 0.5, electric: 0.5, ice: 2, rock: 2, steel: 0.5, fairy: 2 },
            fairy: { fire: 0.5, fighting: 2, poison: 0.5, dragon: 2, dark: 2, steel: 0.5 }
        };

        const allTypes = ['normal', 'fire', 'water', 'electric', 'grass', 'ice', 'fighting', 'poison', 'ground', 'flying', 'psychic', 'bug', 'rock', 'ghost', 'dragon', 'dark', 'steel', 'fairy'];

        const typeEmojis = {
            normal: '‚ö™', fire: 'üî•', water: 'üíß', electric: '‚ö°', grass: 'üåø', ice: '‚ùÑÔ∏è',
            fighting: 'üëä', poison: '‚ò†Ô∏è', ground: 'üåç', flying: 'ü¶Ö', psychic: 'üîÆ', bug: 'üêõ',
            rock: 'ü™®', ghost: 'üëª', dragon: 'üê≤', dark: 'üåë', steel: '‚öôÔ∏è', fairy: 'üßö'
        };

        const genRanges = {
            1: [1, 151], 2: [152, 251], 3: [252, 386], 4: [387, 493],
            5: [494, 649], 6: [650, 721], 7: [722, 809], 8: [810, 905]
        };

        const legendaryIds = [144, 145, 146, 150, 151, 243, 244, 245, 249, 250, 251, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 480, 481, 482, 483, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 638, 639, 640, 641, 642, 643, 644, 645, 646, 647, 648, 649, 716, 717, 718, 719, 720, 721, 785, 786, 787, 788, 789, 790, 791, 792, 800, 801, 802, 807, 808, 809];

        // ==================== API FUNCTIONS ====================
        async function fetchPokemonList(limit = 151, offset = 0) {
            const response = await fetch(`https://pokeapi.co/api/v2/pokemon?limit=${limit}&offset=${offset}`);
            return response.json();
        }

        async function fetchPokemon(nameOrId) {
            // Check cache first
            if (state.loadedPokemonData[nameOrId]) {
                return state.loadedPokemonData[nameOrId];
            }
            const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${nameOrId}`);
            if (!response.ok) throw new Error('Pokemon not found');
            const data = await response.json();
            // Cache the result
            state.loadedPokemonData[data.id] = data;
            state.loadedPokemonData[data.name] = data;
            return data;
        }

        async function fetchPokemonSpecies(nameOrId) {
            const response = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${nameOrId}`);
            if (!response.ok) throw new Error('Species not found');
            return response.json();
        }

        async function fetchEvolutionChain(url) {
            const response = await fetch(url);
            return response.json();
        }

        async function fetchType(name) {
            const response = await fetch(`https://pokeapi.co/api/v2/type/${name}`);
            return response.json();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getSprite(pokemon, shiny = false) {
            if (shiny) {
                return pokemon.sprites?.other?.['official-artwork']?.front_shiny || 
                       pokemon.sprites?.front_shiny || 
                       pokemon.sprites?.other?.['official-artwork']?.front_default;
            }
            return pokemon.sprites?.other?.['official-artwork']?.front_default || pokemon.sprites?.front_default;
        }

        function getGeneration(id) {
            for (const [gen, [min, max]] of Object.entries(genRanges)) {
                if (id >= min && id <= max) return parseInt(gen);
            }
            return 8;
        }

        function isFavorite(id) {
            return state.favorites.includes(id);
        }

        function toggleFavorite(id) {
            if (isFavorite(id)) {
                state.favorites = state.favorites.filter(f => f !== id);
            } else {
                state.favorites.push(id);
            }
            localStorage.setItem('pokeFavorites', JSON.stringify(state.favorites));
        }

        function getTypeEffectiveness(attackType, defenseTypes) {
            let effectiveness = 1;
            defenseTypes.forEach(defType => {
                const mult = typeChart[attackType]?.[defType];
                if (mult !== undefined) effectiveness *= mult;
            });
            return effectiveness;
        }

        function calculateDefensiveMatchups(types) {
            const matchups = { weak: {}, resist: {}, immune: {} };
            allTypes.forEach(attackType => {
                let mult = 1;
                types.forEach(defType => {
                    const eff = typeChart[attackType]?.[defType];
                    if (eff !== undefined) mult *= eff;
                });
                let defMult = 1;
                types.forEach(defType => {
                    allTypes.forEach(atkType => {
                        if (atkType === attackType) {
                            const eff = typeChart[atkType]?.[defType];
                            if (eff !== undefined) defMult *= eff;
                        }
                    });
                });
                
                if (defMult === 0) matchups.immune[attackType] = 0;
                else if (defMult >= 2) matchups.weak[attackType] = defMult;
                else if (defMult <= 0.5) matchups.resist[attackType] = defMult;
            });
            return matchups;
        }

        // ==================== POKEDEX FUNCTIONS ====================
        async function loadPokedex() {
            if (state.isLoading) return;
            state.isLoading = true;
            
            try {
                if (state.allPokemon.length === 0) {
                    const data = await fetchPokemonList(905, 0);
                    state.allPokemon = data.results.map((p, i) => ({
                        name: p.name,
                        id: i + 1,
                        url: p.url
                    }));
                }
                
                await loadMorePokemon();
            } catch (error) {
                console.error('Error loading pokedex:', error);
            }
            
            state.isLoading = false;
        }

        async function loadMorePokemon() {
            const grid = document.getElementById('pokemonGrid');
            const loading = document.getElementById('loadingIndicator');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            loading.classList.remove('hidden');
            
            const typeFilter = document.getElementById('typeFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const genFilter = document.getElementById('genFilter').value;
            const favOnly = document.getElementById('favoritesOnly').checked;
            
            // If type filter is active, we need to load and check each pokemon
            if (typeFilter) {
                await loadPokemonByType(typeFilter, grid);
                loading.classList.add('hidden');
                loadMoreBtn.classList.add('hidden');
                return;
            }
            
            const start = state.currentPage * state.pageSize;
            const end = start + state.pageSize;
            const filtered = getFilteredPokemon();
            const toLoad = filtered.slice(start, end);
            
            for (const poke of toLoad) {
                try {
                    const data = await fetchPokemon(poke.id);
                    state.pokemon.push(data);
                    renderPokemonCard(data, grid);
                } catch (e) {
                    console.error('Error loading pokemon:', poke.name);
                }
            }
            
            state.currentPage++;
            loading.classList.add('hidden');
            
            if (end < filtered.length) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        }

        async function loadPokemonByType(type, grid) {
            grid.innerHTML = '';
            state.pokemon = [];
            
            try {
                const typeData = await fetchType(type);
                const pokemonOfType = typeData.pokemon.slice(0, 60); // Limit to 60 for performance
                
                for (const entry of pokemonOfType) {
                    const urlParts = entry.pokemon.url.split('/');
                    const id = parseInt(urlParts[urlParts.length - 2]);
                    
                    // Apply other filters
                    const search = document.getElementById('searchInput').value.toLowerCase();
                    const genFilter = document.getElementById('genFilter').value;
                    const favOnly = document.getElementById('favoritesOnly').checked;
                    
                    if (search && !entry.pokemon.name.includes(search)) continue;
                    if (genFilter) {
                        const [min, max] = genRanges[genFilter];
                        if (id < min || id > max) continue;
                    }
                    if (favOnly && !isFavorite(id)) continue;
                    if (id > 905) continue; // Skip forms and newer pokemon
                    
                    try {
                        const data = await fetchPokemon(id);
                        state.pokemon.push(data);
                        renderPokemonCard(data, grid);
                    } catch (e) {
                        console.error('Error loading pokemon:', entry.pokemon.name);
                    }
                }
            } catch (e) {
                console.error('Error loading type:', e);
            }
        }

        function getFilteredPokemon() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const genFilter = document.getElementById('genFilter').value;
            const favOnly = document.getElementById('favoritesOnly').checked;
            
            return state.allPokemon.filter(p => {
                if (search && !p.name.includes(search) && !p.id.toString().includes(search)) return false;
                if (genFilter) {
                    const [min, max] = genRanges[genFilter];
                    if (p.id < min || p.id > max) return false;
                }
                if (favOnly && !isFavorite(p.id)) return false;
                return true;
            });
        }

        function renderPokemonCard(pokemon, container) {
            const types = pokemon.types.map(t => t.type.name);
            const mainType = types[0];
            const card = document.createElement('div');
            card.className = 'pokemon-card rounded-2xl p-4 cursor-pointer relative overflow-hidden';
            card.innerHTML = `
                <div class="absolute top-0 left-0 right-0 h-20 type-${mainType} opacity-30 rounded-t-2xl"></div>
                <div class="relative">
                    <button class="favorite-btn absolute top-0 right-0 text-2xl z-10 ${isFavorite(pokemon.id) ? 'active' : ''}" data-id="${pokemon.id}">
                        ${isFavorite(pokemon.id) ? '‚ù§Ô∏è' : 'ü§ç'}
                    </button>
                    <img src="${getSprite(pokemon, state.showShiny)}" alt="${pokemon.name}" 
                        class="w-32 h-32 mx-auto pokemon-sprite relative z-5">
                </div>
                <p class="text-gray-400 text-sm font-mono">#${String(pokemon.id).padStart(3, '0')}</p>
                <h3 class="font-bold text-lg capitalize">${pokemon.name}</h3>
                <div class="flex gap-2 mt-2 flex-wrap">
                    ${types.map(t => `<span class="type-badge type-${t}">${typeEmojis[t]} ${t}</span>`).join('')}
                </div>
            `;
            
            card.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(pokemon.id);
                e.target.classList.toggle('active');
                e.target.textContent = isFavorite(pokemon.id) ? '‚ù§Ô∏è' : 'ü§ç';
            });
            
            card.addEventListener('click', () => showPokemonDetail(pokemon));
            container.appendChild(card);
        }

        async function showPokemonDetail(pokemon) {
            const modal = document.getElementById('pokemonModal');
            const content = document.getElementById('modalContent');
            const types = pokemon.types.map(t => t.type.name);
            const mainType = types[0];
            
            let species;
            try {
                species = await fetchPokemonSpecies(pokemon.id);
            } catch (e) {
                species = { flavor_text_entries: [] };
            }
            
            const description = species.flavor_text_entries?.find(e => e.language.name === 'en')?.flavor_text?.replace(/\f/g, ' ') || 'No description available.';
            
            content.innerHTML = `
                <div class="type-${mainType} p-6 rounded-t-3xl relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/20"></div>
                    <div class="relative flex justify-between items-start">
                        <div>
                            <p class="text-white/70 font-mono">#${String(pokemon.id).padStart(3, '0')}</p>
                            <h2 class="text-3xl font-bold text-white capitalize title-3d">${pokemon.name}</h2>
                            <div class="flex gap-2 mt-2">
                                ${types.map(t => `<span class="type-badge bg-white/30">${typeEmojis[t]} ${t}</span>`).join('')}
                            </div>
                        </div>
                        <button id="closeModal" class="text-white text-3xl hover:scale-110 transition hover:rotate-90 duration-300">√ó</button>
                    </div>
                    <img src="${getSprite(pokemon, state.showShiny)}" alt="${pokemon.name}" 
                        class="w-48 h-48 mx-auto -mb-16 relative z-10 pokemon-sprite float">
                </div>
                <div class="p-6 pt-20 bg-gradient-to-b from-gray-50 to-white rounded-b-3xl">
                    <p class="text-gray-600 mb-4 italic">${description}</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center shadow-inner">
                            <p class="text-gray-500 text-sm">Height</p>
                            <p class="font-bold text-lg text-blue-600">${(pokemon.height / 10).toFixed(1)}m</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center shadow-inner">
                            <p class="text-gray-500 text-sm">Weight</p>
                            <p class="font-bold text-lg text-purple-600">${(pokemon.weight / 10).toFixed(1)}kg</p>
                        </div>
                    </div>
                    
                    <h4 class="font-bold mb-2">Abilities</h4>
                    <div class="flex flex-wrap gap-2 mb-6">
                        ${pokemon.abilities.map(a => `
                            <span class="px-3 py-1 bg-gradient-to-r from-gray-100 to-gray-200 rounded-full text-sm capitalize shadow ${a.is_hidden ? 'border-2 border-dashed border-purple-400' : ''}">
                                ${a.ability.name.replace('-', ' ')} ${a.is_hidden ? '(Hidden)' : ''}
                            </span>
                        `).join('')}
                    </div>
                    
                    <h4 class="font-bold mb-3">Base Stats</h4>
                    <div class="space-y-3">
                        ${pokemon.stats.map(s => {
                            const statName = s.stat.name.replace('special-', 'Sp. ').replace('attack', 'Atk').replace('defense', 'Def');
                            const percentage = Math.min(100, (s.base_stat / 255) * 100);
                            const statClass = s.stat.name.replace('special-', 'sp-');
                            return `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="capitalize font-medium">${statName}</span>
                                        <span class="font-bold">${s.base_stat}</span>
                                    </div>
                                    <div class="bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div class="stat-bar ${statClass} h-full rounded-full" style="width: 0%" data-width="${percentage}"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="mt-6 pt-4 border-t flex gap-2">
                        <button id="addToTeamBtn" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 shadow-lg transition">
                            ‚ûï Add to Team
                        </button>
                        <button id="viewEvolutionBtn" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 shadow-lg transition">
                            üîÑ Evolution
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Animate stat bars
            setTimeout(() => {
                content.querySelectorAll('.stat-bar').forEach(bar => {
                    bar.style.width = bar.dataset.width + '%';
                });
            }, 100);
            
            document.getElementById('closeModal').addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
            
            document.getElementById('addToTeamBtn').addEventListener('click', () => {
                const emptySlot = state.team.findIndex(s => s === null);
                if (emptySlot !== -1) {
                    state.team[emptySlot] = pokemon;
                    localStorage.setItem('pokeTeam', JSON.stringify(state.team));
                    updateTeamDisplay();
                    modal.classList.add('hidden');
                    alert(`${capitalize(pokemon.name)} added to team!`);
                } else {
                    alert('Team is full! Remove a Pok√©mon first.');
                }
            });
            
            document.getElementById('viewEvolutionBtn').addEventListener('click', () => {
                modal.classList.add('hidden');
                navigateTo('evolution');
                document.getElementById('evolutionSearch').value = pokemon.name;
                loadEvolutionChain(pokemon.name);
            });
        }

        function resetPokedex() {
            state.currentPage = 0;
            state.pokemon = [];
            document.getElementById('pokemonGrid').innerHTML = '';
            loadMorePokemon();
        }

        // ==================== BATTLE SIMULATOR ====================
        let battlePokemon = { player: null, opponent: null };

        async function initBattle() {
            const search = document.getElementById('playerPokemonSearch');
            const list = document.getElementById('playerPokemonList');
            
            search.addEventListener('input', async () => {
                const query = search.value.toLowerCase();
                if (query.length < 2) {
                    list.innerHTML = '';
                    return;
                }
                
                const matches = state.allPokemon.filter(p => p.name.includes(query)).slice(0, 12);
                list.innerHTML = '';
                
                for (const match of matches) {
                    try {
                        const pokemon = await fetchPokemon(match.id);
                        const div = document.createElement('div');
                        div.className = 'p-2 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg cursor-pointer hover:from-blue-50 hover:to-blue-100 text-center shadow transition';
                        div.innerHTML = `
                            <img src="${pokemon.sprites.front_default}" class="w-12 h-12 mx-auto">
                            <p class="text-xs capitalize truncate font-medium">${pokemon.name}</p>
                        `;
                        div.addEventListener('click', () => selectBattlePokemon('player', pokemon));
                        list.appendChild(div);
                    } catch (e) {}
                }
            });
            
            document.getElementById('randomOpponent').addEventListener('click', async () => {
                const randomId = Math.floor(Math.random() * 151) + 1;
                const pokemon = await fetchPokemon(randomId);
                selectBattlePokemon('opponent', pokemon);
            });
            
            document.getElementById('startBattle').addEventListener('click', startBattle);
            document.getElementById('newBattle').addEventListener('click', resetBattle);
        }

        function selectBattlePokemon(side, pokemon) {
            battlePokemon[side] = pokemon;
            const container = document.getElementById(`selected${capitalize(side)}Pokemon`);
            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="flex items-center gap-4">
                    <img src="${getSprite(pokemon)}" class="w-20 h-20 pokemon-sprite">
                    <div>
                        <h4 class="font-bold capitalize">${pokemon.name}</h4>
                        <div class="flex gap-1">
                            ${pokemon.types.map(t => `<span class="type-badge type-${t.type.name} text-xs">${typeEmojis[t.type.name]} ${t.type.name}</span>`).join('')}
                        </div>
                        <p class="text-sm text-gray-500">HP: ${pokemon.stats[0].base_stat}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('startBattle').disabled = !(battlePokemon.player && battlePokemon.opponent);
        }

        async function startBattle() {
            document.getElementById('battleSetup').classList.add('hidden');
            document.getElementById('startBattle').classList.add('hidden');
            document.getElementById('battleArena').classList.remove('hidden');
            
            const player = battlePokemon.player;
            const opponent = battlePokemon.opponent;
            
            const calcHP = (base) => Math.floor((2 * base + 31 + 63) * 50 / 100 + 50 + 10);
            
            state.battleState = {
                player: {
                    pokemon: player,
                    hp: calcHP(player.stats[0].base_stat),
                    maxHp: calcHP(player.stats[0].base_stat),
                    moves: player.moves.slice(0, 4).map(m => m.move)
                },
                opponent: {
                    pokemon: opponent,
                    hp: calcHP(opponent.stats[0].base_stat),
                    maxHp: calcHP(opponent.stats[0].base_stat),
                    moves: opponent.moves.slice(0, 4).map(m => m.move)
                },
                turn: 'player',
                log: []
            };
            
            document.getElementById('playerName').textContent = capitalize(player.name);
            document.getElementById('opponentName').textContent = capitalize(opponent.name);
            document.getElementById('playerSprite').src = player.sprites.back_default || getSprite(player);
            document.getElementById('opponentSprite').src = getSprite(opponent);
            
            updateBattleHP();
            renderMoveButtons();
            addBattleLog(`‚öîÔ∏è Battle started! ${capitalize(player.name)} vs ${capitalize(opponent.name)}!`);
        }

        function renderMoveButtons() {
            const container = document.getElementById('moveButtons');
            container.innerHTML = '';
            
            state.battleState.player.moves.forEach((move, i) => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 capitalize shadow-lg transition transform hover:scale-105';
                btn.textContent = move.name.replace('-', ' ');
                btn.addEventListener('click', () => executeMove('player', move));
                container.appendChild(btn);
            });
        }

        async function executeMove(attacker, move) {
            if (state.battleState.turn !== attacker) return;
            
            const atk = state.battleState[attacker];
            const def = state.battleState[attacker === 'player' ? 'opponent' : 'player'];
            
            const atkStat = atk.pokemon.stats[1].base_stat;
            const defStat = def.pokemon.stats[2].base_stat;
            const basePower = 60 + Math.random() * 40;
            
            const defTypes = def.pokemon.types.map(t => t.type.name);
            let typeBonus = 1;
            
            const spriteId = attacker === 'player' ? 'playerSprite' : 'opponentSprite';
            document.getElementById(spriteId).classList.add('attacking');
            
            setTimeout(() => {
                document.getElementById(spriteId).classList.remove('attacking');
                
                const damage = Math.floor((((2 * 50 / 5 + 2) * basePower * atkStat / defStat) / 50 + 2) * typeBonus * (0.85 + Math.random() * 0.15));
                def.hp = Math.max(0, def.hp - damage);
                
                addBattleLog(`üí• ${capitalize(atk.pokemon.name)} used ${move.name.replace('-', ' ')}! Dealt ${damage} damage!`);
                
                const defSprite = attacker === 'player' ? 'opponentSprite' : 'playerSprite';
                document.getElementById(defSprite).classList.add('damaged');
                setTimeout(() => document.getElementById(defSprite).classList.remove('damaged'), 300);
                
                updateBattleHP();
                
                if (def.hp <= 0) {
                    endBattle(attacker);
                    return;
                }
                
                if (attacker === 'player') {
                    state.battleState.turn = 'opponent';
                    document.getElementById('moveButtons').style.pointerEvents = 'none';
                    
                    setTimeout(() => {
                        const aiMove = state.battleState.opponent.moves[Math.floor(Math.random() * state.battleState.opponent.moves.length)];
                        executeMove('opponent', aiMove);
                    }, 1000);
                } else {
                    state.battleState.turn = 'player';
                    document.getElementById('moveButtons').style.pointerEvents = 'auto';
                }
            }, 500);
        }

        function updateBattleHP() {
            const playerPct = (state.battleState.player.hp / state.battleState.player.maxHp) * 100;
            const opponentPct = (state.battleState.opponent.hp / state.battleState.opponent.maxHp) * 100;
            
            document.getElementById('playerHP').style.width = playerPct + '%';
            document.getElementById('opponentHP').style.width = opponentPct + '%';
            
            const getHPColor = (pct) => pct < 25 ? 'from-red-400 to-red-500' : pct < 50 ? 'from-yellow-400 to-yellow-500' : 'from-green-400 to-green-500';
            
            document.getElementById('playerHP').className = `health-bar bg-gradient-to-r ${getHPColor(playerPct)} h-full`;
            document.getElementById('opponentHP').className = `health-bar bg-gradient-to-r ${getHPColor(opponentPct)} h-full`;
            
            document.getElementById('playerHPText').textContent = `${state.battleState.player.hp}/${state.battleState.player.maxHp}`;
            document.getElementById('opponentHPText').textContent = `${state.battleState.opponent.hp}/${state.battleState.opponent.maxHp}`;
        }

        function addBattleLog(message) {
            const log = document.getElementById('battleLog');
            log.innerHTML += `<p class="py-1 border-b border-gray-100">${message}</p>`;
            log.scrollTop = log.scrollHeight;
        }

        function endBattle(winner) {
            document.getElementById('moveButtons').classList.add('hidden');
            document.getElementById('battleResult').classList.remove('hidden');
            
            const resultText = document.getElementById('resultText');
            if (winner === 'player') {
                resultText.textContent = 'üéâ You Win!';
                resultText.className = 'text-3xl font-bold mb-4 text-green-600 title-3d';
            } else {
                resultText.textContent = 'üò¢ You Lose!';
                resultText.className = 'text-3xl font-bold mb-4 text-red-600 title-3d';
            }
        }

        function resetBattle() {
            battlePokemon = { player: null, opponent: null };
            state.battleState = null;
            
            document.getElementById('battleSetup').classList.remove('hidden');
            document.getElementById('startBattle').classList.remove('hidden');
            document.getElementById('battleArena').classList.add('hidden');
            document.getElementById('selectedPlayerPokemon').classList.add('hidden');
            document.getElementById('selectedOpponentPokemon').innerHTML = '<p class="text-gray-400 text-center">Click random to select opponent</p>';
            document.getElementById('startBattle').disabled = true;
            document.getElementById('moveButtons').classList.remove('hidden');
            document.getElementById('battleResult').classList.add('hidden');
            document.getElementById('battleLog').innerHTML = '';
            document.getElementById('playerPokemonSearch').value = '';
            document.getElementById('playerPokemonList').innerHTML = '';
        }

        // ==================== TEAM BUILDER ====================
        let currentTeamSlot = 0;

        function initTeamBuilder() {
            updateTeamDisplay();
            
            document.querySelectorAll('.team-slot').forEach(slot => {
                slot.addEventListener('click', () => {
                    currentTeamSlot = parseInt(slot.dataset.slot);
                    openTeamSelector();
                });
            });
            
            document.getElementById('saveTeam').addEventListener('click', saveTeam);
            document.getElementById('loadTeam').addEventListener('click', loadSavedTeam);
            document.getElementById('exportTeam').addEventListener('click', exportTeam);
            document.getElementById('clearTeam').addEventListener('click', clearTeam);
            document.getElementById('closeTeamSelector').addEventListener('click', () => {
                document.getElementById('teamSelectorModal').classList.add('hidden');
            });
            
            document.getElementById('teamModalSearch').addEventListener('input', searchTeamPokemon);
        }

        function updateTeamDisplay() {
            const slots = document.querySelectorAll('.team-slot');
            slots.forEach((slot, i) => {
                const pokemon = state.team[i];
                if (pokemon) {
                    slot.classList.add('filled');
                    slot.innerHTML = `
                        <img src="${getSprite(pokemon)}" class="w-16 h-16 pokemon-sprite">
                        <p class="font-semibold capitalize text-sm">${pokemon.name}</p>
                        <div class="flex gap-1 mt-1 flex-wrap justify-center">
                            ${pokemon.types.map(t => `<span class="type-badge type-${t.type.name}" style="font-size: 8px; padding: 2px 6px;">${typeEmojis[t.type.name]}</span>`).join('')}
                        </div>
                        <button class="remove-pokemon absolute top-1 right-1 text-red-500 hover:text-red-700 text-lg bg-white rounded-full w-6 h-6 shadow" data-slot="${i}">√ó</button>
                    `;
                    slot.querySelector('.remove-pokemon').addEventListener('click', (e) => {
                        e.stopPropagation();
                        state.team[i] = null;
                        localStorage.setItem('pokeTeam', JSON.stringify(state.team));
                        updateTeamDisplay();
                    });
                } else {
                    slot.classList.remove('filled');
                    slot.innerHTML = `
                        <span class="text-4xl text-gray-300">+</span>
                        <span class="text-gray-400">Slot ${i + 1}</span>
                    `;
                }
            });
            
            analyzeTeam();
        }

        async function openTeamSelector() {
            const modal = document.getElementById('teamSelectorModal');
            modal.classList.remove('hidden');
            document.getElementById('teamModalSearch').value = '';
            document.getElementById('teamModalList').innerHTML = '';
            
            const list = document.getElementById('teamModalList');
            for (let i = 1; i <= 30; i++) {
                try {
                    const pokemon = await fetchPokemon(i);
                    addTeamSelectorItem(pokemon, list);
                } catch (e) {}
            }
        }

        async function searchTeamPokemon() {
            const query = document.getElementById('teamModalSearch').value.toLowerCase();
            const list = document.getElementById('teamModalList');
            list.innerHTML = '';
            
            if (query.length < 2) {
                for (let i = 1; i <= 30; i++) {
                    try {
                        const pokemon = await fetchPokemon(i);
                        addTeamSelectorItem(pokemon, list);
                    } catch (e) {}
                }
                return;
            }
            
            const matches = state.allPokemon.filter(p => p.name.includes(query)).slice(0, 24);
            for (const match of matches) {
                try {
                    const pokemon = await fetchPokemon(match.id);
                    addTeamSelectorItem(pokemon, list);
                } catch (e) {}
            }
        }

        function addTeamSelectorItem(pokemon, container) {
            const div = document.createElement('div');
            div.className = 'p-2 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl cursor-pointer hover:from-blue-50 hover:to-blue-100 text-center transition shadow';
            div.innerHTML = `
                <img src="${pokemon.sprites.front_default}" class="w-12 h-12 mx-auto">
                <p class="text-xs capitalize truncate font-medium">${pokemon.name}</p>
            `;
            div.addEventListener('click', () => {
                state.team[currentTeamSlot] = pokemon;
                localStorage.setItem('pokeTeam', JSON.stringify(state.team));
                updateTeamDisplay();
                document.getElementById('teamSelectorModal').classList.add('hidden');
            });
            container.appendChild(div);
        }

        function analyzeTeam() {
            const teamPokemon = state.team.filter(p => p !== null);
            if (teamPokemon.length === 0) {
                document.getElementById('teamResistances').innerHTML = '<span class="text-gray-400">Add Pok√©mon to see analysis</span>';
                document.getElementById('teamWeaknesses').innerHTML = '';
                document.getElementById('teamWarnings').innerHTML = '';
                return;
            }
            
            const weaknesses = {};
            const resistances = {};
            
            teamPokemon.forEach(p => {
                const types = p.types.map(t => t.type.name);
                const matchups = calculateDefensiveMatchups(types);
                
                Object.entries(matchups.weak).forEach(([type, mult]) => {
                    weaknesses[type] = (weaknesses[type] || 0) + 1;
                });
                Object.entries(matchups.resist).forEach(([type, mult]) => {
                    resistances[type] = (resistances[type] || 0) + 1;
                });
            });
            
            document.getElementById('teamResistances').innerHTML = Object.entries(resistances)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => `<span class="type-badge type-${type}">${typeEmojis[type]} ${type} (${count})</span>`)
                .join('') || '<span class="text-gray-400">None</span>';
            
            document.getElementById('teamWeaknesses').innerHTML = Object.entries(weaknesses)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => `<span class="type-badge type-${type}">${typeEmojis[type]} ${type} (${count})</span>`)
                .join('') || '<span class="text-gray-400">None</span>';
            
            const warnings = [];
            Object.entries(weaknesses).forEach(([type, count]) => {
                if (count >= 3) warnings.push(`‚ö†Ô∏è ${count} Pok√©mon are weak to ${type}!`);
            });
            
            document.getElementById('teamWarnings').innerHTML = warnings.map(w => 
                `<p class="text-orange-600 font-medium bg-orange-50 p-2 rounded-lg">${w}</p>`
            ).join('');
            
            updateTeamStatsChart(teamPokemon);
        }

        function updateTeamStatsChart(teamPokemon) {
            const ctx = document.getElementById('teamStatsChart');
            if (state.charts.teamStats) state.charts.teamStats.destroy();
            
            const statLabels = ['HP', 'Attack', 'Defense', 'Sp. Atk', 'Sp. Def', 'Speed'];
            const avgStats = statLabels.map((_, i) => {
                const sum = teamPokemon.reduce((acc, p) => acc + p.stats[i].base_stat, 0);
                return Math.round(sum / teamPokemon.length);
            });
            
            state.charts.teamStats = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: statLabels,
                    datasets: [{
                        label: 'Team Average Stats',
                        data: avgStats,
                        backgroundColor: ['#22c55e', '#f97316', '#3b82f6', '#a855f7', '#14b8a6', '#f43f5e'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 150 } }
                }
            });
        }

        function saveTeam() {
            const name = prompt('Enter team name:');
            if (!name) return;
            
            const savedTeams = JSON.parse(localStorage.getItem('pokeSavedTeams')) || {};
            savedTeams[name] = state.team.map(p => p ? p.id : null);
            localStorage.setItem('pokeSavedTeams', JSON.stringify(savedTeams));
            alert('Team saved!');
        }

        async function loadSavedTeam() {
            const savedTeams = JSON.parse(localStorage.getItem('pokeSavedTeams')) || {};
            const names = Object.keys(savedTeams);
            
            if (names.length === 0) {
                alert('No saved teams found!');
                return;
            }
            
            const name = prompt(`Enter team name to load:\n${names.join(', ')}`);
            if (!name || !savedTeams[name]) return;
            
            const teamIds = savedTeams[name];
            state.team = await Promise.all(teamIds.map(async id => {
                if (!id) return null;
                return await fetchPokemon(id);
            }));
            
            localStorage.setItem('pokeTeam', JSON.stringify(state.team));
            updateTeamDisplay();
        }

        function exportTeam() {
            const teamData = state.team.filter(p => p).map(p => ({
                id: p.id,
                name: p.name,
                types: p.types.map(t => t.type.name)
            }));
            
            const blob = new Blob([JSON.stringify(teamData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pokemon-team.json';
            a.click();
        }

        function clearTeam() {
            if (!confirm('Clear entire team?')) return;
            state.team = [null, null, null, null, null, null];
            localStorage.setItem('pokeTeam', JSON.stringify(state.team));
            updateTeamDisplay();
        }

        // ==================== EVOLUTION EXPLORER ====================
        async function initEvolutionExplorer() {
            const search = document.getElementById('evolutionSearch');
            const suggestions = document.getElementById('evolutionSuggestions');
            
            for (let i = 1; i <= 16; i++) {
                try {
                    const pokemon = await fetchPokemon(i);
                    addEvolutionSuggestion(pokemon, suggestions);
                } catch (e) {}
            }
            
            search.addEventListener('input', async () => {
                const query = search.value.toLowerCase();
                suggestions.innerHTML = '';
                
                if (query.length < 2) {
                    for (let i = 1; i <= 16; i++) {
                        try {
                            const pokemon = await fetchPokemon(i);
                            addEvolutionSuggestion(pokemon, suggestions);
                        } catch (e) {}
                    }
                    return;
                }
                
                const matches = state.allPokemon.filter(p => p.name.includes(query)).slice(0, 16);
                for (const match of matches) {
                    try {
                        const pokemon = await fetchPokemon(match.id);
                        addEvolutionSuggestion(pokemon, suggestions);
                    } catch (e) {}
                }
            });
        }

        function addEvolutionSuggestion(pokemon, container) {
            const div = document.createElement('div');
            div.className = 'p-2 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg cursor-pointer hover:from-blue-50 hover:to-blue-100 text-center transition shadow';
            div.innerHTML = `
                <img src="${pokemon.sprites.front_default}" class="w-10 h-10 mx-auto">
                <p class="text-xs capitalize truncate font-medium">${pokemon.name}</p>
            `;
            div.addEventListener('click', () => loadEvolutionChain(pokemon.name));
            container.appendChild(div);
        }

        async function loadEvolutionChain(pokemonName) {
            const container = document.getElementById('evolutionChain');
            container.innerHTML = '<div class="flex justify-center"><div class="loading-spinner"></div></div>';
            
            try {
                const species = await fetchPokemonSpecies(pokemonName);
                const evolutionData = await fetchEvolutionChain(species.evolution_chain.url);
                
                const chain = parseEvolutionChain(evolutionData.chain);
                await renderEvolutionChain(chain, container);
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error loading evolution chain</p>';
            }
        }

        function parseEvolutionChain(chain) {
            const result = {
                name: chain.species.name,
                evolutions: []
            };
            
            if (chain.evolves_to.length > 0) {
                chain.evolves_to.forEach(evo => {
                    const details = evo.evolution_details[0] || {};
                    result.evolutions.push({
                        ...parseEvolutionChain(evo),
                        trigger: details.trigger?.name,
                        minLevel: details.min_level,
                        item: details.item?.name,
                        happiness: details.min_happiness,
                        timeOfDay: details.time_of_day,
                        heldItem: details.held_item?.name
                    });
                });
            }
            
            return result;
        }

        async function renderEvolutionChain(chain, container) {
            container.innerHTML = '';
            
            async function renderStage(stage, depth = 0) {
                const pokemon = await fetchPokemon(stage.name);
                const stageDiv = document.createElement('div');
                stageDiv.className = 'flex flex-col items-center';
                
                const imgDiv = document.createElement('div');
                imgDiv.className = 'card-3d rounded-2xl p-4 cursor-pointer transform hover:scale-105 transition';
                imgDiv.innerHTML = `
                    <img src="${getSprite(pokemon)}" class="w-24 h-24 pokemon-sprite">
                    <p class="text-center font-bold capitalize mt-2">${stage.name}</p>
                    <div class="flex justify-center gap-1 mt-1">
                        ${pokemon.types.map(t => `<span class="type-badge type-${t.type.name}" style="font-size: 10px; padding: 2px 8px;">${typeEmojis[t.type.name]}</span>`).join('')}
                    </div>
                `;
                imgDiv.addEventListener('click', () => showPokemonDetail(pokemon));
                stageDiv.appendChild(imgDiv);
                
                if (stage.evolutions.length > 0) {
                    const evoContainer = document.createElement('div');
                    evoContainer.className = 'flex gap-8 mt-4';
                    
                    for (const evo of stage.evolutions) {
                        const evoWrapper = document.createElement('div');
                        evoWrapper.className = 'flex flex-col items-center';
                        
                        const arrow = document.createElement('div');
                        arrow.className = 'flex flex-col items-center my-4';
                        
                        let requirement = '';
                        if (evo.minLevel) requirement = `Level ${evo.minLevel}`;
                        else if (evo.item) requirement = capitalize(evo.item.replace('-', ' '));
                        else if (evo.happiness) requirement = 'High Friendship';
                        else if (evo.trigger === 'trade') requirement = 'Trade';
                        else requirement = 'Special';
                        
                        arrow.innerHTML = `
                            <span class="text-2xl">‚¨áÔ∏è</span>
                            <span class="text-xs bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 px-3 py-1 rounded-full font-medium shadow">${requirement}</span>
                        `;
                        evoWrapper.appendChild(arrow);
                        
                        const subStage = await renderStage(evo, depth + 1);
                        evoWrapper.appendChild(subStage);
                        evoContainer.appendChild(evoWrapper);
                    }
                    
                    stageDiv.appendChild(evoContainer);
                }
                
                return stageDiv;
            }
            
            const fullChain = await renderStage(chain);
            container.appendChild(fullChain);
        }

        // ==================== TYPE MATCHUP ====================
        function initTypeMatchup() {
            const type1Select = document.getElementById('type1Select');
            const type2Select = document.getElementById('type2Select');
            
            allTypes.forEach(type => {
                type1Select.innerHTML += `<option value="${type}">${typeEmojis[type]} ${capitalize(type)}</option>`;
                type2Select.innerHTML += `<option value="${type}">${typeEmojis[type]} ${capitalize(type)}</option>`;
            });
            
            type1Select.addEventListener('change', updateTypeMatchup);
            type2Select.addEventListener('change', updateTypeMatchup);
            
            renderFullTypeChart();
        }

        function updateTypeMatchup() {
            const type1 = document.getElementById('type1Select').value;
            const type2 = document.getElementById('type2Select').value;
            
            if (!type1) {
                document.getElementById('weakTo').innerHTML = '<span class="text-gray-400">Select a type</span>';
                document.getElementById('resistantTo').innerHTML = '';
                document.getElementById('immuneTo').innerHTML = '';
                return;
            }
            
            const types = type2 ? [type1, type2] : [type1];
            const matchups = { weak: {}, resist: {}, immune: {} };
            
            allTypes.forEach(attackType => {
                let mult = 1;
                types.forEach(defType => {
                    const eff = typeChart[attackType]?.[defType];
                    if (eff !== undefined) mult *= eff;
                });
                
                if (mult === 0) matchups.immune[attackType] = 0;
                else if (mult >= 2) matchups.weak[attackType] = mult;
                else if (mult < 1) matchups.resist[attackType] = mult;
            });
            
            document.getElementById('weakTo').innerHTML = Object.entries(matchups.weak)
                .map(([type, mult]) => `<span class="type-badge type-${type}">${typeEmojis[type]} ${type} ${mult}x</span>`)
                .join('') || '<span class="text-gray-400">None</span>';
            
            document.getElementById('resistantTo').innerHTML = Object.entries(matchups.resist)
                .map(([type, mult]) => `<span class="type-badge type-${type}">${typeEmojis[type]} ${type} ${mult}x</span>`)
                .join('') || '<span class="text-gray-400">None</span>';
            
            document.getElementById('immuneTo').innerHTML = Object.keys(matchups.immune)
                .map(type => `<span class="type-badge type-${type}">${typeEmojis[type]} ${type}</span>`)
                .join('') || '<span class="text-gray-400">None</span>';
        }

        function renderFullTypeChart() {
            const table = document.getElementById('typeChart');
            let html = '<tr><th class="p-2"></th>';
            
            allTypes.forEach(type => {
                html += `<th class="p-1 type-${type} text-white text-center font-bold" style="min-width: 40px" title="${capitalize(type)}">${type.slice(0, 3).toUpperCase()}</th>`;
            });
            html += '</tr>';
            
            allTypes.forEach(atkType => {
                html += `<tr><td class="p-1 type-${atkType} text-white font-bold text-center" title="${capitalize(atkType)}">${atkType.slice(0, 3).toUpperCase()}</td>`;
                allTypes.forEach(defType => {
                    const eff = typeChart[atkType]?.[defType] ?? 1;
                    let bg = 'bg-gray-100';
                    let text = '';
                    
                    if (eff === 0) { bg = 'bg-gray-800 text-white'; text = '0'; }
                    else if (eff === 0.5) { bg = 'bg-red-300'; text = '¬Ω'; }
                    else if (eff === 2) { bg = 'bg-green-400'; text = '2'; }
                    else { text = '1'; }
                    
                    html += `<td class="${bg} text-center p-1 text-xs font-bold border border-gray-200">${text}</td>`;
                });
                html += '</tr>';
            });
            
            table.innerHTML = html;
        }

        // ==================== RANDOMIZER ====================
        function initRandomizer() {
            const typeSelect = document.getElementById('randomType');
            allTypes.forEach(type => {
                typeSelect.innerHTML += `<option value="${type}">${typeEmojis[type]} ${capitalize(type)}</option>`;
            });
            
            document.getElementById('randomSingle').addEventListener('click', generateRandomPokemon);
            document.getElementById('randomTeam').addEventListener('click', generateRandomTeam);
            
            document.querySelectorAll('.challenge-btn').forEach(btn => {
                btn.addEventListener('click', () => runChallenge(btn.dataset.challenge));
            });
        }

        async function generateRandomPokemon() {
            const container = document.getElementById('randomResult');
            container.innerHTML = '<div class="flex justify-center"><div class="loading-spinner"></div></div>';
            
            const gen = document.getElementById('randomGen').value;
            const type = document.getElementById('randomType').value;
            const legendaryOnly = document.getElementById('legendaryOnly').checked;
            const excludeLegendary = document.getElementById('excludeLegendary').checked;
            
            let candidates = [...state.allPokemon];
            
            if (gen) {
                const [min, max] = genRanges[gen];
                candidates = candidates.filter(p => p.id >= min && p.id <= max);
            }
            
            if (legendaryOnly) {
                candidates = candidates.filter(p => legendaryIds.includes(p.id));
            } else if (excludeLegendary) {
                candidates = candidates.filter(p => !legendaryIds.includes(p.id));
            }
            
            let pokemon;
            let attempts = 0;
            
            do {
                const random = candidates[Math.floor(Math.random() * candidates.length)];
                pokemon = await fetchPokemon(random.id);
                attempts++;
                
                if (type) {
                    const hasType = pokemon.types.some(t => t.type.name === type);
                    if (!hasType && attempts < 50) pokemon = null;
                }
            } while (!pokemon && attempts < 50);
            
            if (!pokemon) {
                container.innerHTML = '<p class="text-center text-red-500">No Pok√©mon found with those criteria</p>';
                return;
            }
            
            renderRandomResult([pokemon], container);
        }

        async function generateRandomTeam() {
            const container = document.getElementById('randomResult');
            container.innerHTML = '<div class="flex justify-center"><div class="loading-spinner"></div></div>';
            
            const gen = document.getElementById('randomGen').value;
            const legendaryOnly = document.getElementById('legendaryOnly').checked;
            const excludeLegendary = document.getElementById('excludeLegendary').checked;
            
            let candidates = [...state.allPokemon];
            
            if (gen) {
                const [min, max] = genRanges[gen];
                candidates = candidates.filter(p => p.id >= min && p.id <= max);
            }
            
            if (legendaryOnly) {
                candidates = candidates.filter(p => legendaryIds.includes(p.id));
            } else if (excludeLegendary) {
                candidates = candidates.filter(p => !legendaryIds.includes(p.id));
            }
            
            const team = [];
            const usedIds = new Set();
            
            while (team.length < 6 && usedIds.size < candidates.length) {
                const random = candidates[Math.floor(Math.random() * candidates.length)];
                if (!usedIds.has(random.id)) {
                    usedIds.add(random.id);
                    const pokemon = await fetchPokemon(random.id);
                    team.push(pokemon);
                }
            }
            
            renderRandomResult(team, container);
        }

        async function runChallenge(challenge) {
            const container = document.getElementById('randomResult');
            container.innerHTML = '<div class="flex justify-center"><div class="loading-spinner"></div></div>';
            
            let team = [];
            
            switch (challenge) {
                case 'mono':
                    const type = allTypes[Math.floor(Math.random() * allTypes.length)];
                    container.innerHTML = `<p class="text-center text-purple-600 font-bold mb-4">üéØ Mono-${capitalize(type)} Challenge!</p><div class="flex justify-center"><div class="loading-spinner"></div></div>`;
                    
                    for (let i = 1; i <= 151 && team.length < 6; i++) {
                        try {
                            const p = await fetchPokemon(i);
                            if (p.types.some(t => t.type.name === type)) team.push(p);
                        } catch (e) {}
                    }
                    team = team.sort(() => Math.random() - 0.5).slice(0, 6);
                    break;
                    
                case 'starter':
                    const starters = [1, 4, 7, 152, 155, 158, 252, 255, 258, 387, 390, 393, 495, 498, 501, 650, 653, 656, 722, 725, 728, 810, 813, 816];
                    const randomStarters = starters.sort(() => Math.random() - 0.5).slice(0, 6);
                    for (const id of randomStarters) {
                        team.push(await fetchPokemon(id));
                    }
                    break;
                    
                case 'baby':
                    const babies = [172, 173, 174, 175, 236, 238, 239, 240, 298, 360, 406, 433, 438, 439, 440, 446, 447, 458];
                    const randomBabies = babies.sort(() => Math.random() - 0.5).slice(0, 6);
                    for (const id of randomBabies) {
                        team.push(await fetchPokemon(id));
                    }
                    break;
                    
                case 'nfe':
                    const nfe = [];
                    for (let i = 1; i <= 50 && nfe.length < 20; i++) {
                        try {
                            const species = await fetchPokemonSpecies(i);
                            if (species.evolves_from_species === null) {
                                const evoChain = await fetchEvolutionChain(species.evolution_chain.url);
                                if (evoChain.chain.evolves_to.length > 0) {
                                    nfe.push(i);
                                }
                            }
                        } catch (e) {}
                    }
                    const randomNfe = nfe.sort(() => Math.random() - 0.5).slice(0, 6);
                    for (const id of randomNfe) {
                        team.push(await fetchPokemon(id));
                    }
                    break;
            }
            
            renderRandomResult(team, container, challenge);
        }

        function renderRandomResult(pokemon, container, challenge = null) {
            let html = challenge ? `<p class="text-center text-purple-600 font-bold mb-4">üèÜ ${capitalize(challenge)} Challenge!</p>` : '';
            html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';
            
            pokemon.forEach(p => {
                html += `
                    <div class="card-3d rounded-xl p-4 text-center cursor-pointer transform hover:scale-105 transition" onclick="showPokemonDetail(window.randomPokemon[${p.id}])">
                        <img src="${getSprite(p)}" class="w-20 h-20 mx-auto pokemon-sprite">
                        <p class="font-bold capitalize">${p.name}</p>
                        <div class="flex justify-center gap-1 mt-1 flex-wrap">
                            ${p.types.map(t => `<span class="type-badge type-${t.type.name}" style="font-size: 10px; padding: 2px 8px;">${typeEmojis[t.type.name]}</span>`).join('')}
                        </div>
                    </div>
                `;
                window.randomPokemon = window.randomPokemon || {};
                window.randomPokemon[p.id] = p;
            });
            
            html += '</div>';
            
            if (pokemon.length === 6) {
                html += `
                    <button class="mt-4 w-full px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 shadow-lg transition" onclick="useRandomTeam()">
                        ‚úÖ Use This Team
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }

        window.useRandomTeam = function() {
            const pokemon = Object.values(window.randomPokemon || {}).slice(0, 6);
            state.team = pokemon;
            localStorage.setItem('pokeTeam', JSON.stringify(state.team));
            navigateTo('team');
            updateTeamDisplay();
        };

        // ==================== COMPARE TOOL ====================
        function initCompareTool() {
            ['compare1', 'compare2', 'compare3'].forEach((id, index) => {
                const input = document.getElementById(id);
                const suggestions = document.getElementById(id + 'Suggestions');
                
                input.addEventListener('input', async () => {
                    const query = input.value.toLowerCase();
                    suggestions.innerHTML = '';
                    
                    if (query.length < 2) return;
                    
                    const matches = state.allPokemon.filter(p => p.name.includes(query)).slice(0, 5);
                    
                    for (const match of matches) {
                        const div = document.createElement('div');
                        div.className = 'p-2 bg-gradient-to-r from-gray-50 to-gray-100 rounded cursor-pointer hover:from-blue-50 hover:to-blue-100 text-sm capitalize shadow transition';
                        div.textContent = match.name;
                        div.addEventListener('click', async () => {
                            const pokemon = await fetchPokemon(match.id);
                            state.comparePokemon[index] = pokemon;
                            input.value = pokemon.name;
                            suggestions.innerHTML = '';
                            
                            document.getElementById(id + 'Selected').innerHTML = `
                                <div class="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-2 shadow">
                                    <img src="${pokemon.sprites.front_default}" class="w-10 h-10">
                                    <span class="capitalize font-medium">${pokemon.name}</span>
                                    <button class="ml-auto text-red-500 hover:text-red-700 font-bold" onclick="clearCompare(${index})">√ó</button>
                                </div>
                            `;
                        });
                        suggestions.appendChild(div);
                    }
                });
            });
            
            document.getElementById('compareBtn').addEventListener('click', compareStats);
        }

        window.clearCompare = function(index) {
            state.comparePokemon[index] = null;
            document.getElementById(`compare${index + 1}`).value = '';
            document.getElementById(`compare${index + 1}Selected`).innerHTML = '';
        };

        function compareStats() {
            const pokemon = state.comparePokemon.filter(p => p !== null);
            
            if (pokemon.length < 2) {
                alert('Select at least 2 Pok√©mon to compare');
                return;
            }
            
            const statNames = ['HP', 'Attack', 'Defense', 'Sp. Atk', 'Sp. Def', 'Speed'];
            const colors = ['#ef4444', '#3b82f6', '#22c55e'];
            
            if (state.charts.compareBar) state.charts.compareBar.destroy();
            state.charts.compareBar = new Chart(document.getElementById('compareBarChart'), {
                type: 'bar',
                data: {
                    labels: statNames,
                    datasets: pokemon.map((p, i) => ({
                        label: capitalize(p.name),
                        data: p.stats.map(s => s.base_stat),
                        backgroundColor: colors[i],
                        borderRadius: 8
                    }))
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            if (state.charts.compareRadar) state.charts.compareRadar.destroy();
            state.charts.compareRadar = new Chart(document.getElementById('compareRadarChart'), {
                type: 'radar',
                data: {
                    labels: statNames,
                    datasets: pokemon.map((p, i) => ({
                        label: capitalize(p.name),
                        data: p.stats.map(s => s.base_stat),
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '40',
                        pointBackgroundColor: colors[i]
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        r: { beginAtZero: true }
                    }
                }
            });
            
            const winnersGrid = document.getElementById('winnersGrid');
            const statWinners = document.getElementById('statWinners');
            statWinners.classList.remove('hidden');
            
            winnersGrid.innerHTML = statNames.map((stat, i) => {
                const winner = pokemon.reduce((best, p) => 
                    p.stats[i].base_stat > best.stats[i].base_stat ? p : best
                );
                return `
                    <div class="card-3d rounded-xl p-3 text-center">
                        <p class="text-xs text-gray-500 mb-1 font-medium">${stat}</p>
                        <img src="${winner.sprites.front_default}" class="w-12 h-12 mx-auto">
                        <p class="text-sm font-bold capitalize">${winner.name}</p>
                        <p class="text-lg font-bold text-blue-600">${winner.stats[i].base_stat}</p>
                    </div>
                `;
            }).join('');
        }

        // ==================== NAVIGATION ====================
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            document.getElementById('mobileMenu').classList.add('hidden');
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            // Populate type filter with emojis
            const typeFilter = document.getElementById('typeFilter');
            allTypes.forEach(type => {
                typeFilter.innerHTML += `<option value="${type}">${typeEmojis[type]} ${capitalize(type)}</option>`;
            });
            
            // Navigation
            document.querySelectorAll('[data-page]').forEach(btn => {
                btn.addEventListener('click', () => navigateTo(btn.dataset.page));
            });
            
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.toggle('hidden');
            });
            
            // Load all pokemon list first
            const data = await fetchPokemonList(905, 0);
            state.allPokemon = data.results.map((p, i) => ({
                name: p.name,
                id: i + 1,
                url: p.url
            }));
            
            // Initialize all modules
            await loadPokedex();
            initBattle();
            initTeamBuilder();
            initEvolutionExplorer();
            initTypeMatchup();
            initRandomizer();
            initCompareTool();
            
            // Pokedex filters
            document.getElementById('searchInput').addEventListener('input', debounce(resetPokedex, 500));
            document.getElementById('typeFilter').addEventListener('change', resetPokedex);
            document.getElementById('genFilter').addEventListener('change', resetPokedex);
            document.getElementById('favoritesOnly').addEventListener('change', resetPokedex);
            document.getElementById('shinyToggle').addEventListener('change', (e) => {
                state.showShiny = e.target.checked;
                resetPokedex();
            });
            
            document.getElementById('loadMoreBtn').addEventListener('click', loadMorePokemon);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Start the app
        init();
    </script>
</body>
</html>